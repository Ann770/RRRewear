extends ../layouts/main

block content
  .container.mt-4
    h1.mb-4 My Swap Requests
    .row
      .col-md-12
        if requests && requests.length > 0
          each request in requests
            .card.mb-3
              .card-body
                .row
                  .col-md-4
                    h5.card-title Requested Item
                    if request.requested_item
                      img.img-fluid.mb-2(src=request.requested_item.image_url, alt=request.requested_item.title, style='max-height: 200px;')
                      h6= request.requested_item.title
                      p.text-muted= request.requested_item.brand_name
                  .col-md-4
                    h5.card-title Offered Item
                    if request.offered_item
                      img.img-fluid.mb-2(src=request.offered_item.image_url, alt=request.offered_item.title, style='max-height: 200px;')
                      h6= request.offered_item.title
                      p.text-muted= request.offered_item.brand_name
                  .col-md-4
                    h5.card-title Status
                    p.badge(class={
                      'bg-warning': request.status === 'pending',
                      'bg-success': request.status === 'accepted',
                      'bg-danger': request.status === 'rejected'
                    })= request.status
                    if request.message
                      p.mt-2= request.message
                    if request.status === 'pending' && request.receiver_id === user.user_id
                      .mt-3
                        button.btn.btn-success.me-2(onclick=`updateRequestStatus(${request.request_id}, 'accepted')`) Accept
                        button.btn.btn-danger(onclick=`updateRequestStatus(${request.request_id}, 'rejected')`) Reject
                    if request.status === 'pending' && request.requester_id === user.user_id
                      .mt-3
                        button.btn.btn-danger(onclick=`deleteRequest(${request.request_id})`) Delete Request
        else
          .alert.alert-info No swap requests found.

block scripts
  script.
    async function updateRequestStatus(requestId, status) {
      try {
        const response = await fetch(`/swap-requests/${requestId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to update request status');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating the request status');
      }
    }

    async function deleteRequest(requestId) {
      if (confirm('Are you sure you want to delete this swap request?')) {
        try {
          const response = await fetch(`/swap-requests/${requestId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Failed to delete request');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while deleting the request');
        }
      }
    } 